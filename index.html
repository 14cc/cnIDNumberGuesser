<!DOCTYPE html>
<html>

<head>
    <title>ID Verification</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        .input-group {
            margin-bottom: 10px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
        }

        .input-group input[type="text"] {
            width: 100%;
            padding: 5px;
        }

        .input-group textarea {
            width: 100%;
            height: 200px;
            padding: 5px;
        }

        .btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            float: right;
        }

        .btn:hover {
            background-color: #45a049;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="input-group">
            <label for="id_input">请输入身份证号码，用星号 (*) 替代未知数字：</label>
            <input type="text" id="id_input" placeholder="身份证号码">
        </div>
        <div class="input-group">
            <button class="btn" onclick="verifyID()">验证</button>
        </div>
        <div class="input-group">
            <label for="output">输出内容：</label>
            <textarea id="output" readonly></textarea>
        </div>
    </div>

    <script>
        function is_valid_id_number(id_number) {
            if (!id_number.match(/^\d{17}[\dX]$/)) {
                return false;
            }
            const factors = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
            const id_remainders = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];
            const total_sum = id_number.split('').slice(0, 17).reduce((sum, digit, index) => sum + parseInt(digit) * factors[index], 0);
            const remainder = total_sum % 11;
            return id_remainders[remainder] === id_number[17];
        }

        function verifyID() {
            const id_input = document.getElementById('id_input').value.trim();
            const output = document.getElementById('output');
            output.value = '';

            if (id_input.length !== 18) {
                output.value = '请输入18位身份证号码，并用星号 (*) 替代缺失的数字。';
                return;
            }

            const count_asterisks = (id_input.match(/\*/g) || []).length;
            if (count_asterisks > 18) {
                output.value = '星号的数量不能超过18个。';
                return;
            }

            if (count_asterisks === 0) {
                output.value = '没有缺失的数字。';
                return;
            }

            const city_code = id_input.slice(0, 6);
            const birth_year = id_input.slice(6, 10);
            const birth_month = id_input.slice(10, 12);
            const birth_day = id_input.slice(12, 14);
            const tail_digits = id_input.slice(14, 18);

            output.value += '>>> 城市代码: ' + city_code + '\n';
            output.value += '>>> 出生年份: ' + birth_year + '\n';
            output.value += '>>> 出生月份: ' + birth_month + '\n';
            output.value += '>>> 出生日期: ' + birth_day + '\n';
            output.value += '>>> 顺序号: ' + tail_digits + '\n';

            const fs = require('fs');

            // 从文件中读取城市数据
            const cityFile = './citycodes.txt';
            const cityData = fs.readFileSync(cityFile, 'utf8');
            const valid_cities = cityData.split('\n').map(city => city.trim());

            console.log(valid_cities);


            if (!valid_cities.includes(city_code)) {
                output.value += '>>> 错误：无效的城市代码';
                return;
            }

            const current_year = new Date().getFullYear();
            const birth_year_options = [];
            if (birth_year === '****') {
                for (let year = 1949; year <= current_year; year++) {
                    birth_year_options.push(year);
                }
            } else {
                const birth_year_pattern = birth_year.replace(/\*/g, '\\d');
                for (let year = 1949; year <= current_year; year++) {
                    if (year.toString().match(birth_year_pattern)) {
                        birth_year_options.push(year);
                    }
                }
            }

            if (birth_year_options.length === 0) {
                output.value += '>>> 错误：无效的出生年份';
                return;
            }

            output.value += '>>> 有效的城市代码: ' + valid_cities.join(', ') + '\n';
            output.value += '>>> 有效的出生年份: ' + birth_year_options.join(', ') + '\n';

            const birth_month_options = [];
            if (birth_month === '00') {
                output.value += '>>> 错误：无效的月份';
                return;
            } else if (birth_month === '**') {
                for (let month = 1; month <= 12; month++) {
                    birth_month_options.push(month.toString().padStart(2, '0'));
                }
            } else if (birth_month[0] === '*' && birth_month[1] !== '*') {
                const firstDigit = parseInt(birth_month[1]);
                for (let month = 1; month <= 12; month++) {
                    if (Math.floor(month / 10) === firstDigit) {
                        birth_month_options.push(month.toString().padStart(2, '0'));
                    }
                }
            } else if (birth_month[0] !== '*' && birth_month[1] === '*') {
                const secondDigit = parseInt(birth_month[0]);
                for (let month = 10; month <= 12; month++) {
                    if (Math.floor(month / 10) === secondDigit) {
                        birth_month_options.push(month.toString().padStart(2, '0'));
                    }
                }
            } else {
                birth_month_options.push(birth_month);
            }

            output.value += '>>> 有效的出生月份: ' + birth_month_options.join(', ') + '\n';

            const year_days = {
                '01': [...Array(31).keys()].map(day => (day + 1).toString().padStart(2, '0')),
                '02': [...Array(28).keys()].map(day => (day + 1).toString().padStart(2, '0')),
                '03': [...Array(31).keys()].map(day => (day + 1).toString().padStart(2, '0')),
                '04': [...Array(30).keys()].map(day => (day + 1).toString().padStart(2, '0')),
                '05': [...Array(31).keys()].map(day => (day + 1).toString().padStart(2, '0')),
                '06': [...Array(30).keys()].map(day => (day + 1).toString().padStart(2, '0')),
                '07': [...Array(31).keys()].map(day => (day + 1).toString().padStart(2, '0')),
                '08': [...Array(31).keys()].map(day => (day + 1).toString().padStart(2, '0')),
                '09': [...Array(30).keys()].map(day => (day + 1).toString().padStart(2, '0')),
                '10': [...Array(31).keys()].map(day => (day + 1).toString().padStart(2, '0')),
                '11': [...Array(30).keys()].map(day => (day + 1).toString().padStart(2, '0')),
                '12': [...Array(31).keys()].map(day => (day + 1).toString().padStart(2, '0'))
            };

            const birth_day_options = {};
            for (const month_option of birth_month_options) {
                if (birth_day === '**') {
                    birth_day_options[month_option] = year_days[month_option];
                } else if (birth_day[0] === '*' && birth_day[1] !== '*') {
                    const firstDigit = parseInt(birth_day[1]);
                    birth_day_options[month_option] = year_days[month_option].filter(day => Math.floor(parseInt(day) / 10) === firstDigit);
                } else if (birth_day[0] !== '*' && birth_day[1] === '*') {
                    const secondDigit = parseInt(birth_day[0]);
                    if (secondDigit === 1) {
                        birth_day_options[month_option] = [...Array(10).keys()].map(day => (day + 10).toString().padStart(2, '0'));
                    } else if (secondDigit === 0) {
                        birth_day_options[month_option] = [...Array(9).keys()].map(day => (day + 1).toString().padStart(2, '0'));
                    } else if (secondDigit === 2) {
                        birth_day_options[month_option] = [...Array(12).keys()].map(day => (day + 20).toString().padStart(2, '0'));
                    } else {
                        output.value += '>>> 错误：无效的日期';
                        return;
                    }
                } else {
                    birth_day_options[month_option] = [birth_day];
                }
            }

            output.value += '>>> 有效的出生日期: ' + JSON.stringify(birth_day_options) + '\n';

            const tail_options = [];
            if (tail_digits === '****') {
                for (let tail = 0; tail <= 9999; tail++) {
                    tail_options.push(tail.toString().padStart(4, '0'));
                }
            } else {
                const count_asterisks = (tail_digits.match(/\*/g) || []).length;
                if (count_asterisks === 0) {
                    tail_options.push(tail_digits);
                } else if (count_asterisks === 1) {
                    for (let digit = 0; digit <= 9; digit++) {
                        tail_options.push(tail_digits.replace('*', digit.toString()));
                    }
                } else if (count_asterisks === 2) {
                    for (let digit1 = 0; digit1 <= 9; digit1++) {
                        for (let digit2 = 0; digit2 <= 9; digit2++) {
                            tail_options.push(tail_digits.replace(/\*/g, (m, i) => i === 0 ? digit1.toString() : digit2.toString()));
                        }
                    }
                } else if (count_asterisks === 3) {
                    for (let digit1 = 0; digit1 <= 9; digit1++) {
                        for (let digit2 = 0; digit2 <= 9; digit2++) {
                            for (let digit3 = 0; digit3 <= 9; digit3++) {
                                tail_options.push(tail_digits.replace(/\*/g, (m, i) => {
                                    if (i === 0) return digit1.toString();
                                    if (i === 1) return digit2.toString();
                                    return digit3.toString();
                                }));
                            }
                        }
                    }
                } else {
                    output.value += '>>> 错误：无效的后四位数字';
                    return;
                }
            }

            output.value += '>>> 数据集大小: ' + (valid_cities.length * birth_year_options.length * birth_month_options.length * Object.keys(birth_day_options).length * tail_options.length) + '\n';

            const cache = [];

            function split_and_verify_range(option_range) {
                const result = [];
                for (const option of option_range) {
                    const real_id = option;
                    if (is_valid_id_number(real_id)) {
                        result.push(real_id);
                    }
                }
                return result;
            }

            const thread_count = 8; // 线程数量，根据实际情况进行修改
            const range_size = Math.ceil(tail_options.length / thread_count);
            const option_ranges = [];
            for (let i = 0; i < tail_options.length; i += range_size) {
                option_ranges.push(tail_options.slice(i, i + range_size));
            }

            const start_time = performance.now();
            const threads = [];
            for (const option_range of option_ranges) {
                const t = new WorkerThread(option_range);
                threads.push(t);
            }

            function WorkerThread(option_range) {
                const worker = new Worker(URL.createObjectURL(new Blob([`
                self.onmessage = function(e) {
                    const result = split_and_verify_range(e.data);
                    self.postMessage(result);
                }
            `])));
                worker.onmessage = function (e) {
                    cache.push(...e.data);
                    if (threads.every(t => t.finished)) {
                        output.value += '>>> 所有线程已完成\n';
                        output.value += '>>> 耗时: ' + (performance.now() - start_time) + 'ms\n';
                        output.value += '>>> 结果:\n' + cache.join('\n');
                    }
                };
                worker.postMessage(option_range);
                return { worker, finished: false };
            }

            function split_and_verify_range(option_range) {
                const result = [];
                for (const option of option_range) {
                    const real_id = city_code + birth_year_options[0] + birth_month_options[0] + Object.values(birth_day_options)[0][0] + option;
                    if (is_valid_id_number(real_id)) {
                        result.push(real_id);
                    }
                }
                return result;
            }
        }
    </script>
</body>

</html>